# 1C-Money-ClientBank

Проект содержит клиенты для банков, которые могут быть использованы только в конфигурации 1С:Деньги (https://v8.1c.ru/money). Основная идея заключается в эмуляции работы мобильного приложения банка для получения токена доступа, с помощью которого можно в автоматическом режиме подключаться к серверу банка для получения справочной информации.

Основная цель: предоставить удобный интерфейс для конфигурации 1С:Деньги при этом обеспечить максимальную защиту от использования злоумышленниками

Меры защиты для пользователей:
* обработки не сохраняют никакие из передаваемых им пользователем данных
* обработки декларируют используемые внешние ресурсы и могут быть работать в безопасном режиме платформы 1С:Предприятие при использовании профиля безопасности
* на каждое значимое действие пользователя банк отправляет запрос с СМС кодом, в котором описано запрашиваемое действие, т.е. не получится под видом SMS о регистрации нового мобильного устройства запросить SMS для совершения несанкционированного платежа 

Меры защиты для банков:
* обработки поставляются без исходного кода и защищены от декомпиляции
* обработки не обращаются к объектам основной конфигурации, кроме функциональности БСП при их регистрации в системе
* обработки могут быть использованы только с конфигурацией 1С:Деньги и только в интерактивном режиме
* идентификаторы устройств и токены доступа возвращаются в зашифрованном виде, что исключает их использование в других приложениях

Программный интерфейс обработок:
```bsl
// Функция - Получить идентификатор нового устройства
//
// Возвращаемое значение:
//  Строка - идентификатор нового устройства, который будет необходимо передавать в контексте выполнения в поле ИдентификаторУстройства
//
Процедура ПолучитьИдентификаторНовогоУстройства()
КонецПроцедуры

// Функция - Параметры получения токена доступа
//
// Возвращаемое значение:
//  Массив - массив объектов типа Структура со следующими свойствами
//    * Имя - Строка - имя параметра, которое будет необходимо передать в процедуры ПолучитьТокенДоступа и ОтправитьКодПодтверждения
//    * Заголовок - Строка - заголовок параметра
//    * РежимПароля - Булево - необходимо ли скрывать введенные символы (необязательный)
//    * Маска - Строка - маска поля ввода параметра на форме, в соответствие со спецификацией 1С (необязательный)
//
Процедура ПараметрыПолученияТокенаДоступа()
КонецПроцедуры

// Процедура - Получить токен доступа
//
// Параметры:
//  КонтекстВыполнения - Структура -
//   * ИдентификаторУстройства - Строка - см. ПолучитьИдентификаторНовогоУстройства()
//   * ТокенДоступа - Строка - если возвращается, должен быть записан в учетной системе
//   * ТребуетсяПодтверждение - если возвращается, необходимо вызвать процедуру ОтправитьКодПодтверждения
//   * СрокОжиданияПодтверждения - Число - если возвращается - срок, в течение которых необходимо вызвать ОтправитьКодПодтверждения
//   * ТекстОшибки - Строка - если возвращается - текст ошибки взимодействия
//
Процедура ПолучитьТокенДоступа(КонтекстВыполнения)
КонецПроцедуры

// Процедура - Отправить код подтверждения
//
// Параметры:
//  КонтекстВыполнения - Структура -
//   * ИдентификаторУстройства - Строка - см. ПолучитьИдентификаторНовогоУстройства()
//   * КодПодтверждения - Строка - код подтверждения предыдущей операции
//   * ТокенДоступа - Строка - передать токен, полученный на предыдущем шаге, записать после вызова
//   * ТекстОшибки - Строка - если возвращается - текст ошибки взимодействия
//
Процедура ОтправитьКодПодтверждения(КонтекстВыполнения)
КонецПроцедуры

// Функция - Получить доступные счета
//
// Параметры:
//  КонтекстВыполнения - Структура -
//   * ИдентификаторУстройства - Строка - 
//   * ТокенДоступа - Строка
// 
// Возвращаемое значение:
//  ТаблицаЗначений -
//   * НомерСчета - Строка - номер счета
//   * Наименование - Строка - наименование банковского счета
//   * Валюта - Строка - буквенный код валюты 
//   * Остаток - Число - остаток в валюте счета 
//
Функция ПолучитьДоступныеСчета(КонтекстВыполнения)
КонецФункции

// Функция - Получить выписку
//
// Параметры:
//  КонтекстВыполнения - Структура - 
//   * ИдентификаторУстройства - Строка - см. ПолучитьИдентификаторНовогоУстройства()
//   * ТокенДоступа - Строка
//   * НомераСчетов - Массив - если указано, номера счетов, по которым необходимо получить выписку
//   * НачалоПериода - Число - начало периода с которого необходимо получить выписку
// 
// Возвращаемое значение:
//  ТаблицаЗначений - таблица содержит колонки для передачи в учетную систему
//
Функция ПолучитьВыписку(КонтекстВыполнения)
КонецФункции
```

Первоначальное получение токена доступа
1. Сформировать идентификатор устройства с помощью ПолучитьИдентификаторНовогоУстройства() для каждого нового устройства
2. Запросить у пользователя параметры ПараметрыПолученияТокенаДоступа()
3. Выполнить вызов ПолучитьТокенДоступа(), передав в него идентификатор устройства и параметры получения доступа
4. Сохранить ТокенДоступа
5. При необходимости вызвать ОтправитьКодПодтверждения, передав ТокенДоступа
6. Сохранить ТокенДоступа

Использование сервиса
1. Вызвать необходимую операцию, передав ТокенДоступа
2. Сохранить ТокенДоступа
3. Вызвать необходимую операцию, передав ТокенДоступа
4. Сохранить ТокенДоступа
5. ...

То есть при вызове каждой операции, за исключением ПолучитьТокенДоступа() необходимо передать ТокенДоступа, полученный после предыдущего вызова. После вызова, независимо от наличия в результате свойства ТекстОшибки, свойство ТокенДоступа необходимо сохранить
